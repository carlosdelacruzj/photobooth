<ion-header>
  <ion-toolbar>
    <ion-title>Configuracion</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <ion-toast
    [isOpen]="!!errorMessage"
    [message]="errorMessage"
    duration="2000"
    (didDismiss)="errorMessage = ''"
  ></ion-toast>
  <h2>Photobooth</h2>
  <p>Temporizador y camara antes de empezar.</p>

  <ion-list>
    <ion-item>
      <ion-label>Segundos por foto: {{ secondsPerShot }}</ion-label>
      <ion-range
        min="1"
        max="10"
        step="1"
        [(ngModel)]="secondsPerShot"
      ></ion-range>
    </ion-item>

    <ion-item>
      <ion-label>Camara frontal</ion-label>
      <ion-toggle [(ngModel)]="useFrontCamera"></ion-toggle>
    </ion-item>

  </ion-list>

  <ion-item lines="none">
    <ion-label>Fondo</ion-label>
  </ion-item>
  <ion-button expand="block">
    <label style="display: block; width: 100%;">
      Agregar fondo
      <input
        type="file"
        accept="image/*"
        (change)="onBackgroundSelected($event)"
        style="display: none;"
      />
    </label>
  </ion-button>
  <ion-button expand="block" color="medium" (click)="selectBackground(null)">
    Sin fondo
  </ion-button>

  <div *ngIf="backgroundGallery.length > 0; else noBackground">
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 8px;">
      <div
        *ngFor="let item of backgroundGallery"
        (click)="selectBackground(item.id)"
        [style.border]="selectedBackgroundId === item.id ? '2px solid #3880ff' : '1px solid #444'"
        style="border-radius: 8px; padding: 4px; cursor: pointer;"
      >
        <img
          [src]="item.dataUrl"
          alt="Fondo"
          style="width: 100%; height: 80px; object-fit: cover; border-radius: 6px;"
        />
        <ion-button
          size="small"
          color="danger"
          expand="block"
          (click)="removeBackground(item.id); $event.stopPropagation()"
        >
          Eliminar
        </ion-button>
      </div>
    </div>
  </div>
  <ng-template #noBackground>
    <p>No hay fondos guardados.</p>
  </ng-template>

  <ion-item lines="none">
    <ion-label>Vista previa</ion-label>
  </ion-item>
  <canvas
    #previewCanvas
    style="width: 100%; max-width: 270px; border-radius: 8px; background: #000;"
  ></canvas>

  <ion-button expand="block" color="medium" (click)="openPreview()">
    Probar plantilla
  </ion-button>

  <ion-button expand="block" (click)="start()">Empezar</ion-button>
</ion-content>

<ion-modal [isOpen]="isPreviewOpen" (didDismiss)="closePreview()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Vista previa</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closePreview()">Cerrar</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding">
      <canvas
        #fullPreviewCanvas
        style="width: 100%; max-width: 540px; border-radius: 12px; background: #000;"
      ></canvas>
    </ion-content>
  </ng-template>
</ion-modal>
